<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>بازی برنامه‌ریزی پوکر سالاد میوه - نسخه آنلاین</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- HTML2Canvas for image saving -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            color: #374151;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            text-align: center;
            flex-direction: column;
            padding: 2rem 1rem;
        }
        .container {
            background-color: #fff;
            padding: 2.5rem;
            border-radius: 1.5rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            max-width: 95%;
            width: 800px;
        }
        .tab-buttons {
            display: flex;
            justify-content: center;
            margin-bottom: 2rem;
            border-bottom: 2px solid #e5e7eb;
            flex-wrap: wrap;
        }
        .tab-button {
            padding: 0.75rem 1.5rem;
            font-weight: bold;
            color: #6b7280;
            cursor: pointer;
            transition: all 0.3s ease;
            border-bottom: 2px solid transparent;
            margin-bottom: -2px;
        }
        .tab-button.active {
            color: #10b981;
            border-bottom-color: #10b981;
        }
        .tab-button.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .navigation-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 2rem;
        }
        .fruit-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1.5rem;
            margin-top: 2rem;
        }
        .fruit-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            border-radius: 0.75rem;
            padding: 1rem;
            background-color: #f9fafb;
            border: 2px solid transparent;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
        }
        .fruit-item.unvoted {
            border-color: #ef4444;
            background-color: #fef2f2;
        }
        .fruit-emoji {
            font-size: 4rem;
            margin-bottom: 0.5rem;
        }
        .story-points-select {
            margin-top: 0.75rem;
            width: 80px;
            text-align: center;
            border-radius: 0.5rem;
            border: 1px solid #d1d5db;
            padding: 0.5rem;
            background-color: white;
        }
        .hidden {
            display: none;
        }
        .results-section {
            margin-top: 2rem;
            padding: 1.5rem;
            background-color: #f0fdf4;
            border-radius: 1rem;
            border: 1px solid #d1fae5;
        }
        .cards-container {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 1rem;
            margin-top: 1rem;
        }
        .card {
            background-color: #4b5563;
            color: #fff;
            padding: 1rem;
            border-radius: 0.5rem;
            font-size: 1.5rem;
            font-weight: bold;
            width: 60px;
            height: 90px;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-top: 2rem;
        }
        .result-card {
            background-color: #f9fafb;
            padding: 1.5rem;
            border-radius: 1rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        .total-points {
            background-color: #10b981;
            color: white;
            padding: 1.5rem;
            border-radius: 1rem;
            margin-top: 2rem;
            font-size: 1.5rem;
            font-weight: bold;
        }
        .alert-message {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #f87171;
            color: white;
            padding: 1rem 2rem;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            display: none;
        }
        .button-primary {
            background-color: #10b981;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: bold;
            transition: all 0.3s ease;
            border: none;
            cursor: pointer;
        }
        .button-primary:hover {
            background-color: #059669;
        }
        .button-secondary {
            background-color: #3b82f6;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: bold;
            transition: all 0.3s ease;
            border: none;
            cursor: pointer;
        }
        .button-secondary:hover {
            background-color: #2563eb;
        }
        .button-back {
            background-color: #6b7280;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: bold;
            transition: all 0.3s ease;
            border: none;
            cursor: pointer;
        }
        .button-back:hover {
            background-color: #4b5563;
        }
        .summary-card {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            padding: 1.5rem;
            border-radius: 1rem;
            margin-top: 2rem;
            text-align: center;
        }
        .summary-value {
            font-size: 2.5rem;
            font-weight: bold;
            margin: 0.5rem 0;
        }
        .pmpiran-logo {
            width: 200px;
            height: auto;
            margin: 1rem auto;
            display: block;
        }
        .website-link {
            display: inline-block;
            margin-top: 1rem;
            padding: 0.75rem 1.5rem;
            background-color: #3b82f6;
            color: white;
            text-decoration: none;
            border-radius: 0.5rem;
            font-weight: bold;
            transition: background-color 0.3s ease;
        }
        .website-link:hover {
            background-color: #2563eb;
        }
        .social-links {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-top: 1.5rem;
            flex-wrap: wrap;
        }
        .social-link {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            color: white;
            font-size: 1.5rem;
            transition: all 0.3s ease;
            text-decoration: none;
        }
        .social-link.instagram {
            background: linear-gradient(45deg, #f09433, #e6683c, #dc2743, #cc2366, #bc1888);
        }
        .social-link.telegram {
            background-color: #0088cc;
        }
        .social-link.linkedin {
            background-color: #0077b5;
        }
        .social-link:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        .founder-linkedin {
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 1px solid #e5e7eb;
        }
        .fruit-selection {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            justify-content: center;
            margin: 1.5rem 0;
        }
        .fruit-option {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 0.5rem;
            border: 2px solid #e5e7eb;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .fruit-option.selected {
            border-color: #10b981;
            background-color: #f0fdf4;
        }
        .fruit-option:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .selection-emoji {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }
        .online-users {
            background-color: #e0f2fe;
            padding: 1rem;
            border-radius: 0.5rem;
            margin-top: 1rem;
        }
        .user-list {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }
        .user-badge {
            background-color: #3b82f6;
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 1rem;
            font-size: 0.875rem;
        }
        .refresh-btn {
            margin-top: 1rem;
            background-color: #6b7280;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            border: none;
            cursor: pointer;
        }
        .vote-options {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            justify-content: center;
            margin-top: 1rem;
        }
        .vote-option {
            background-color: #e5e7eb;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .vote-option.selected {
            background-color: #10b981;
            color: white;
        }
        .fruit-vote-item {
            margin-bottom: 1.5rem;
            padding: 1rem;
            border-radius: 0.75rem;
            background-color: #f9fafb;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }
        .fruit-vote-emoji {
            font-size: 3rem;
            margin-bottom: 0.5rem;
        }
        .progress-bar {
            height: 10px;
            background-color: #e5e7eb;
            border-radius: 5px;
            overflow: hidden;
            margin-top: 0.5rem;
        }
        .progress-fill {
            height: 100%;
            background-color: #10b981;
            border-radius: 5px;
            transition: width 0.3s ease;
        }
        .consensus-badge {
            background-color: #10b981;
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 1rem;
            font-size: 0.875rem;
            margin-top: 0.5rem;
        }
        .disagreement-badge {
            background-color: #ef4444;
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 1rem;
            font-size: 0.875rem;
            margin-top: 0.5rem;
        }
    </style>
</head>
<body>

<div class="container">
    <!-- Tab Navigation -->
    <div class="tab-buttons">
        <button id="tab-enter" class="tab-button active">ورود</button>
        <button id="tab-scenario" class="tab-button">سناریو بازی</button>
        <button id="tab-info" class="tab-button">برنامه‌ریزی پوکر</button>
        <button id="tab-vote" class="tab-button disabled">امتیاز دادن</button>
        <button id="tab-results" class="tab-button disabled hidden">نتایج</button>
        <button id="tab-pmpiran" class="tab-button">PMPiran</button>
    </div>

    <!-- Tab Content -->
    <div id="tab-content-enter" class="tab-content">
        <h1 class="text-3xl font-bold mb-6">به بازی برنامه‌ریزی پوکر خوش آمدید!</h1>
        
        <div class="mb-4">
            <p>برای شروع، نام خود و نام گروه را وارد کنید.</p>
            <input type="text" id="userName" placeholder="نام شما" class="w-full px-4 py-2 mt-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
            <input type="text" id="groupName" placeholder="نام گروه" class="w-full px-4 py-2 mt-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
        </div>
        
        <div id="onlineUsers" class="online-users hidden">
            <h3 class="font-bold">اعضای آنلاین:</h3>
            <div id="usersList" class="user-list"></div>
            <button id="refreshUsers" class="refresh-btn">بروزرسانی لیست</button>
        </div>
        
        <button id="startButton" class="button-primary w-full mt-4">
            شروع بازی
        </button>
    </div>

    <div id="tab-content-scenario" class="tab-content hidden">
        <p id="displayGroupName" class="mb-4 text-gray-500"></p>
        <h1 class="text-3xl font-bold mb-2">سناریوی بازی</h1>
        <p class="mb-6 text-gray-700 leading-relaxed text-right">
            در این بازی، شما و تیم‌تان باید با هم یک سالاد میوه درست کنید. هر میوه یک تسک یا "استوری" است. برای درست کردن سالاد، باید با هم برای هر میوه امتیاز داستان (Story Point) تعیین کنید. تیم شما باید تلاش لازم را تخمین زده و برای هر میوه توافق کند که چقدر استوری پوینت دارد.
        </p>
        
        <div class="bg-yellow-50 p-4 rounded-xl mb-4">
            <h3 class="text-xl font-bold mb-4 text-center">لطفاً ۱۰ میوه را برای سالاد خود انتخاب کنید:</h3>
            <div class="fruit-selection" id="fruitSelection">
                <!-- میوه‌ها برای انتخاب در اینجا نمایش داده می‌شوند -->
            </div>
            <p id="selectionCount" class="text-center mt-4 font-bold">0 میوه انتخاب شده از ۱۰ میوه</p>
        </div>
        
        <div class="navigation-buttons">
            <button id="nextToInfo" class="button-secondary" disabled>
                ادامه
            </button>
        </div>
    </div>

    <div id="tab-content-info" class="tab-content hidden">
        <p id="displayGroupName2" class="mb-4 text-gray-500"></p>
        <h1 class="text-3xl font-bold mb-2">برنامه‌ریزی پوکر چیست؟</h1>
        <div class="text-right text-gray-700 leading-relaxed space-y-4">
            <p>برنامه‌ریزی پوکر (Planning Poker) یک تکنیک تخمین زدن در مدیریت چابک است که بر اساس اجماع نظر تیم عمل می‌کند. در این روش:</p>
            <ul class="list-disc pr-5 space-y-2">
                <li>هر عضو تیم به صورت مستقل تخمین خود را ارائه می‌دهد</li>
                <li>در صورت تفاوت در تخمین‌ها، اعضای تیم درباره دلایل تفاوت بحث می‌کنند</li>
                <li>فرآیند تا رسیدن به اجماع ادامه می‌یابد</li>
                <li>این روش از اثر anchoring (تأثیر نظر اولیه) جلوگیری می‌کند</li>
            </ul>
            <p class="bg-blue-50 p-4 rounded-xl border border-blue-200">
                <strong>فواید برنامه‌ریزی پوکر:</strong> افزایش دقت تخمین‌ها، مشارکت تمام اعضای تیم، درک بهتر از پیچیدگی تسک‌ها و ایجاد گفت‌وگوی سازنده در تیم.
            </p>
        </div>
        
        <div class="navigation-buttons">
            <button id="backToScenario" class="button-back">
                بازگشت
            </button>
            <button id="nextToVote" class="button-secondary">
                ادامه به رأی‌گیری
            </button>
        </div>
    </div>

    <div id="tab-content-vote" class="tab-content hidden">
        <p id="displayGroupName3" class="mb-4 text-gray-500"></p>
        <h1 class="text-3xl font-bold mb-2">امتیازدهی به میوه‌ها</h1>
        <p class="mb-6 text-gray-700 leading-relaxed text-right">
            لطفاً برای هر میوه بر اساس میزان پیچیدگی و زمانی که برای تهیه آن نیاز است، امتیاز دهید. از مقیاس فیبوناچی استفاده کنید (۱, ۲, ۳, ۵, ۸, ۱۳, ۲۰, ۴۰, ۱۰۰, ۲۰۰).
        </p>
        
        <div id="fruitGrid" class="fruit-grid">
            <!-- میوه‌های انتخاب شده برای رأی‌گیری در اینجا نمایش داده می‌شوند -->
        </div>
        
        <div class="navigation-buttons">
            <button id="backToInfo" class="button-back">
                بازگشت
            </button>
            <button id="submitVotes" class="button-primary">
                ثبت رأی‌ها
            </button>
        </div>
    </div>

    <div id="tab-content-results" class="tab-content hidden">
        <p id="displayGroupName4" class="mb-4 text-gray-500"></p>
        <h1 class="text-3xl font-bold mb-2">نتایج برنامه‌ریزی پوکر</h1>
        
        <div id="resultsContainer">
            <!-- نتایج در اینجا نمایش داده می‌شوند -->
        </div>
        
        <div class="bg-blue-50 p-4 rounded-xl mt-6">
            <h3 class="text-xl font-bold mb-2">سرعت تیم (Velocity)</h3>
            <p class="mb-4">سرعت تیم نشان‌دهنده میزان کاری است که تیم می‌تواند در یک اسپرینت انجام دهد.</p>
            <div class="flex items-center justify-center">
                <label for="velocityInput" class="ml-2">سرعت تیم:</label>
                <input type="number" id="velocityInput" min="1" class="w-24 px-3 py-2 border rounded-lg">
            </div>
        </div>
        
        <div id="finalResultsContainer" class="mt-6">
            <!-- نتایج نهایی در اینجا نمایش داده می‌شوند -->
        </div>
        
        <div class="navigation-buttons">
            <button id="backToVote" class="button-back">
                بازگشت به رأی‌گیری
            </button>
            <button id="saveFinalImageButton" class="button-secondary">
                ذخیره نتایج
            </button>
        </div>
    </div>

    <div id="tab-content-pmpiran" class="tab-content hidden">
        <h1 class="text-3xl font-bold mb-6">PMPiran</h1>
        
        <img src="https://via.placeholder.com/200x100/3B82F6/FFFFFF?text=PMPiran" alt="PMPiran Logo" class="pmpiran-logo">
        
        <p class="text-gray-700 leading-relaxed mb-4 text-right">
            PMPiran یک پلتفرم آموزشی آنلاین برای مدیریت پروژه و آمادگی برای آزمون‌های بین‌المللی مانند PMP است. ما با ارائه منابع آموزشی به روز و مطابق با استانداردهای جهانی، به متخصصان کمک می‌کنیم تا مهارت‌های خود را ارتقا دهند.
        </p>
        
        <a href="https://pmpiran.com" target="_blank" class="website-link">
            بازدید از وبسایت PMPiran
        </a>
        
        <div class="social-links">
            <a href="#" class="social-link instagram">
                <i class="fab fa-instagram"></i>
            </a>
            <a href="#" class="social-link telegram">
                <i class="fab fa-telegram"></i>
            </a>
            <a href="#" class="social-link linkedin">
                <i class="fab fa-linkedin"></i>
            </a>
        </div>
        
        <div class="founder-linkedin">
            <p class="text-gray-600">برای ارتباط با مؤسس PMPiran:</p>
            <a href="#" class="text-blue-500 hover:underline">صفحه لینکدین محمد امین صلاحی</a>
        </div>
        
        <div class="navigation-buttons">
            <button id="backToEnterFromPmpiran" class="button-back">
                بازگشت به صفحه شروع
            </button>
        </div>
    </div>

    <div id="alertMessage" class="alert-message">
        لطفا به همه میوه‌ها امتیاز بدهید.
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Global variables and elements
        const tabButtons = document.querySelectorAll('.tab-button');
        const tabContents = document.querySelectorAll('.tab-content');
        const groupNameInput = document.getElementById('groupName');
        const userNameInput = document.getElementById('userName');
        const startButton = document.getElementById('startButton');
        const nextToInfoButton = document.getElementById('nextToInfo');
        const nextToVoteButton = document.getElementById('nextToVote');
        const submitVotesButton = document.getElementById('submitVotes');
        const saveFinalImageButton = document.getElementById('saveFinalImageButton');
        const displayGroupName = document.getElementById('displayGroupName');
        const displayGroupName2 = document.getElementById('displayGroupName2');
        const displayGroupName3 = document.getElementById('displayGroupName3');
        const displayGroupName4 = document.getElementById('displayGroupName4');
        const fruitGrid = document.getElementById('fruitGrid');
        const fruitSelection = document.getElementById('fruitSelection');
        const selectionCount = document.getElementById('selectionCount');
        const resultsContainer = document.getElementById('resultsContainer');
        const finalResultsContainer = document.getElementById('finalResultsContainer');
        const totalPointsElement = document.getElementById('totalPoints');
        const velocityInput = document.getElementById('velocityInput');
        const alertMessage = document.getElementById('alertMessage');
        const resultsSection = document.getElementById('resultsSection');
        const onlineUsersSection = document.getElementById('onlineUsers');
        const usersList = document.getElementById('usersList');
        const refreshUsersButton = document.getElementById('refreshUsers');
        
        // Navigation buttons
        const backToScenario = document.getElementById('backToScenario');
        const backToInfo = document.getElementById('backToInfo');
        const backToVote = document.getElementById('backToVote');
        const backToEnterFromPmpiran = document.getElementById('backToEnterFromPmpiran');
        
        let currentGroupName = '';
        let currentUserName = '';
        let userVotes = {};
        let fruitsRendered = false;
        let selectedFruits = [];

        // Fruit data with emojis - 15 fruits for selection
        const allFruits = [
            { name: 'موز', emoji: '🍌' },
            { name: 'سیب', emoji: '🍎' },
            { name: 'بلوبری', emoji: '🫐' },
            { name: 'آناناس', emoji: '🍍' },
            { name: 'آووکادو', emoji: '🥑' },
            { name: 'پرتقال', emoji: '🍊' },
            { name: 'توت فرنگی', emoji: '🍓' },
            { name: 'سیب سبز', emoji: '🍏' },
            { name: 'کیوی', emoji: '🥝' },
            { name: 'گیلاس', emoji: '🍒' },
            { name: 'هندوانه', emoji: '🍉' },
            { name: 'انگور', emoji: '🍇' },
            { name: 'لیمو', emoji: '🍋' },
            { name: 'خربزه', emoji: '🍈' },
            { name: 'هلو', emoji: '🍑' }
        ];
        
        // Allowed story points based on the user's request
        const storyPoints = [1, 2, 3, 5, 8, 13, 20, 40, 100, 200];

        // Tab switching logic
        const switchTab = (tabId) => {
            // غیرفعال کردن تب‌های مربوط به مراحل بعدی اگر کاربر هنوز به آن مرحله نرسیده
            if (tabId === 'vote' && !fruitsRendered) {
                return;
            }
            
            tabButtons.forEach(button => {
                button.classList.remove('active');
            });
            tabContents.forEach(content => {
                content.classList.add('hidden');
            });
            const selectedTabButton = document.getElementById(`tab-${tabId}`);
            if (selectedTabButton) {
                selectedTabButton.classList.add('active');
            }
            const selectedTabContent = document.getElementById(`tab-content-${tabId}`);
            if (selectedTabContent) {
                selectedTabContent.classList.remove('hidden');
            }
        };

        // فعال کردن تب
        const enableTab = (tabId) => {
            const tabButton = document.getElementById(`tab-${tabId}`);
            if (tabButton) {
                tabButton.classList.remove('disabled');
                tabButton.classList.remove('hidden');
            }
        };

        // Show temporary alert message
        function showAlertMessage() {
            alertMessage.style.display = 'block';
            setTimeout(() => {
                alertMessage.style.display = 'none';
            }, 3000);
        }

        // Render fruit selection options
        function renderFruitSelection() {
            fruitSelection.innerHTML = '';
            allFruits.forEach(fruit => {
                const fruitOption = document.createElement('div');
                fruitOption.className = 'fruit-option';
                fruitOption.dataset.fruit = fruit.name;
                
                fruitOption.innerHTML = `
                    <span class="selection-emoji">${fruit.emoji}</span>
                    <span class="text-sm">${fruit.name}</span>
                `;
                
                fruitOption.addEventListener('click', function() {
                    toggleFruitSelection(fruit);
                });
                
                fruitSelection.appendChild(fruitOption);
            });
        }
        
        // Toggle fruit selection
        function toggleFruitSelection(fruit) {
            const index = selectedFruits.findIndex(f => f.name === fruit.name);
            
            if (index === -1) {
                if (selectedFruits.length < 10) {
                    selectedFruits.push(fruit);
                    document.querySelector(`.fruit-option[data-fruit="${fruit.name}"]`).classList.add('selected');
                }
            } else {
                selectedFruits.splice(index, 1);
                document.querySelector(`.fruit-option[data-fruit="${fruit.name}"]`).classList.remove('selected');
            }
            
            // Update selection count
            selectionCount.textContent = `${selectedFruits.length} میوه انتخاب شده از ۱۰ میوه`;
            
            // Enable/disable next button
            nextToInfoButton.disabled = selectedFruits.length !== 10;
        }

        // Render fruits for voting
        function renderFruitsForVoting() {
            fruitGrid.innerHTML = '';
            selectedFruits.forEach(fruit => {
                const fruitItem = document.createElement('div');
                fruitItem.className = 'fruit-item unvoted';
                fruitItem.dataset.fruit = fruit.name;
                
                fruitItem.innerHTML = `
                    <div class="fruit-emoji">${fruit.emoji}</div>
                    <h3 class="font-bold">${fruit.name}</h3>
                    <select class="story-points-select" data-fruit="${fruit.name}">
                        <option value="">امتیاز دهید</option>
                        ${storyPoints.map(point => `<option value="${point}">${point}</option>`).join('')}
                    </select>
                `;
                
                fruitGrid.appendChild(fruitItem);
            });
            
            // Add event listeners to selects
            document.querySelectorAll('.story-points-select').forEach(select => {
                select.addEventListener('change', function() {
                    const fruitName = this.dataset.fruit;
                    const fruitItem = document.querySelector(`.fruit-item[data-fruit="${fruitName}"]`);
                    
                    if (this.value) {
                        fruitItem.classList.remove('unvoted');
                        userVotes[fruitName] = parseInt(this.value);
                    } else {
                        fruitItem.classList.add('unvoted');
                        delete userVotes[fruitName];
                    }
                });
            });
            
            fruitsRendered = true;
            enableTab('vote');
        }

        // Calculate and display results
        function calculateResults() {
            // In a real app, this would collect votes from all users
            // For this demo, we'll simulate some votes
            const simulatedVotes = {};
            
            selectedFruits.forEach(fruit => {
                // Simulate different votes for each fruit
                const votes = [];
                const baseVote = userVotes[fruit.name] || Math.floor(Math.random() * 5) + 1;
                
                // Add some variation to simulate multiple users
                for (let i = 0; i < 5; i++) {
                    const variation = Math.floor(Math.random() * 3) - 1; // -1, 0, or 1
                    votes.push(Math.max(1, baseVote + variation));
                }
                
                simulatedVotes[fruit.name] = votes;
            });
            
            // Display results
            resultsContainer.innerHTML = '';
            
            selectedFruits.forEach(fruit => {
                const votes = simulatedVotes[fruit.name];
                const average = votes.reduce((a, b) => a + b, 0) / votes.length;
                const consensus = Math.max(...votes) === Math.min(...votes);
                
                const resultCard = document.createElement('div');
                resultCard.className = 'result-card';
                
                resultCard.innerHTML = `
                    <div class="fruit-vote-emoji">${fruit.emoji}</div>
                    <h3 class="font-bold">${fruit.name}</h3>
                    <div class="mt-2">
                        <p>امتیازات: ${votes.join(', ')}</p>
                        <p>میانگین: ${average.toFixed(1)}</p>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${Math.min(100, average * 5)}%"></div>
                        </div>
                    </div>
                    ${consensus ? 
                        '<div class="consensus-badge">توافق کامل</div>' : 
                        '<div class="disagreement-badge">نیاز به بحث بیشتر</div>'
                    }
                `;
                
                resultsContainer.appendChild(resultCard);
            });
            
            // Calculate total points
            const totalPoints = Object.values(simulatedVotes).reduce((total, votes) => {
                const average = votes.reduce((a, b) => a + b, 0) / votes.length;
                return total + Math.round(average);
            }, 0);
            
            finalResultsContainer.innerHTML = `
                <div class="summary-card">
                    <h3 class="text-xl font-bold">مجموع امتیازات سالاد میوه</h3>
                    <div class="summary-value">${totalPoints}</div>
                    <p>امتیاز کل</p>
                </div>
            `;
            
            enableTab('results');
        }

        // Save user data to localStorage
        function saveUserToStorage() {
            const userData = {
                name: currentUserName,
                group: currentGroupName,
                joinedAt: new Date().toISOString()
            };
            
            // Get existing users or initialize empty array
            const existingUsers = JSON.parse(localStorage.getItem('pokerUsers') || '[]');
            
            // Check if user already exists
            const userIndex = existingUsers.findIndex(u => u.name === currentUserName && u.group === currentGroupName);
            
            if (userIndex === -1) {
                existingUsers.push(userData);
            } else {
                existingUsers[userIndex] = userData;
            }
            
            // Save back to localStorage
            localStorage.setItem('pokerUsers', JSON.stringify(existingUsers));
            localStorage.setItem('pokerCurrentUser', JSON.stringify(userData));
            
            // Update users list
            updateUsersList();
        }
        
        // Update online users list
        function updateUsersList() {
            const users = JSON.parse(localStorage.getItem('pokerUsers') || '[]');
            const currentGroup = JSON.parse(localStorage.getItem('pokerCurrentUser') || '{}').group;
            
            // Filter users by current group
            const groupUsers = users.filter(user => user.group === currentGroup);
            
            // Clear and update users list
            usersList.innerHTML = '';
            groupUsers.forEach(user => {
                const userBadge = document.createElement('div');
                userBadge.className = 'user-badge';
                userBadge.textContent = user.name;
                usersList.appendChild(userBadge);
            });
            
            // Show online users section if there are users
            onlineUsersSection.classList.toggle('hidden', groupUsers.length === 0);
        }

        // Save final image
        function saveFinalImage() {
            html2canvas(document.querySelector('#tab-content-results')).then(canvas => {
                const link = document.createElement('a');
                link.download = `نتایج-پوکر-سالاد-میوه-${currentGroupName}.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();
            });
        }

        // Event Listeners
        startButton.addEventListener('click', function() {
            const userName = userNameInput.value.trim();
            const groupName = groupNameInput.value.trim();
            
            if (!userName || !groupName) {
                showAlertMessage();
                return;
            }

            currentUserName = userName;
            currentGroupName = groupName;
            
            displayGroupName.textContent = `نام گروه: ${currentGroupName} - کاربر: ${currentUserName}`;
            displayGroupName2.textContent = `نام گروه: ${currentGroupName} - کاربر: ${currentUserName}`;
            displayGroupName3.textContent = `نام گروه: ${currentGroupName} - کاربر: ${currentUserName}`;
            displayGroupName4.textContent = `نام گروه: ${currentGroupName} - کاربر: ${currentUserName}`;

            // Save user to storage
            saveUserToStorage();
            
            // Render fruit selection
            renderFruitSelection();
            
            switchTab('scenario');
        });

        nextToInfoButton.addEventListener('click', function() {
            switchTab('info');
        });

        nextToVoteButton.addEventListener('click', function() {
            renderFruitsForVoting();
            switchTab('vote');
        });

        submitVotesButton.addEventListener('click', function() {
            // Check if all fruits have been voted on
            const allVoted = selectedFruits.every(fruit => userVotes[fruit.name]);
            
            if (!allVoted) {
                showAlertMessage();
                return;
            }
            
            calculateResults();
            switchTab('results');
        });

        saveFinalImageButton.addEventListener('click', function() {
            saveFinalImage();
        });

        // Navigation back buttons
        backToScenario.addEventListener('click', function() {
            switchTab('scenario');
        });

        backToInfo.addEventListener('click', function() {
            switchTab('info');
        });

        backToVote.addEventListener('click', function() {
            switchTab('vote');
        });

        backToEnterFromPmpiran.addEventListener('click', function() {
            switchTab('enter');
        });

        // Tab click handlers
        document.getElementById('tab-enter').addEventListener('click', function() {
            switchTab('enter');
        });

        document.getElementById('tab-scenario').addEventListener('click', function() {
            switchTab('scenario');
        });

        document.getElementById('tab-info').addEventListener('click', function() {
            switchTab('info');
        });

        document.getElementById('tab-vote').addEventListener('click', function() {
            if (!this.classList.contains('disabled')) {
                switchTab('vote');
            }
        });

        document.getElementById('tab-results').addEventListener('click', function() {
            if (!this.classList.contains('disabled')) {
                switchTab('results');
            }
        });

        document.getElementById('tab-pmpiran').addEventListener('click', function() {
            switchTab('pmpiran');
        });

        // Refresh users list button
        refreshUsersButton.addEventListener('click', function() {
            updateUsersList();
        });

        // Velocity input change
        velocityInput.addEventListener('change', function() {
            const velocity = parseInt(this.value) || 0;
            const totalPoints = parseInt(document.querySelector('.summary-value').textContent);
            
            if (velocity > 0 && totalPoints > 0) {
                const sprintsNeeded = Math.ceil(totalPoints / velocity);
                finalResultsContainer.innerHTML += `
                    <div class="summary-card mt-4">
                        <h3 class="text-xl font-bold">تعداد اسپرینت‌های مورد نیاز</h3>
                        <div class="summary-value">${sprintsNeeded}</div>
                        <p>اسپرینت (با سرعت ${velocity} در هر اسپرینت)</p>
                    </div>
                `;
            }
        });

        // Initialize
        updateUsersList();
        
        // Check for existing user data
        const existingUser = JSON.parse(localStorage.getItem('pokerCurrentUser') || '{}');
        if (existingUser.name && existingUser.group) {
            userNameInput.value = existingUser.name;
            groupNameInput.value = existingUser.group;
        }
    });
</script>

</body>
</html>